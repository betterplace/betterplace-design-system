version: v1.0
name: Deployment
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Publish NPM Package
    task:
      secrets:
        - name: betterplace-design-system
        - name: betterplace-secrets
      jobs:
        - name: Deploy to NPM
          commands:
            - cache restore
            - cache restore npm-package-$SEMAPHORE_GIT_BRANCH
            - cache restore package-$SEMAPHORE_GIT_BRANCH
            - npm set-script prepare ""
            - HUSKY=0 npm publish
            - gh api --method POST -H Accept=application/vnd.github+json /repos/betterplace/betterplace-design-system/deployments -f ref='$SEMAPHORE_GIT_SHA' -f description='Deployed from semaphore' -f environment='production'
